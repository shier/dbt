{{ config(materialized='table',schema='dbo')}}

with updateData as (
    select 
    FTstg.[temp_ConsignmentID_DocketID],
    FTtmp.[Consignor_Skey],
    FTtmp.[Auction_Skey],
    FTtmp.[Item_Skey],
    FTstg.[ConsignmentID],
    FTstg.[AuctionID],
    FTstg.[ItemID],
    FTstg.[CustomerAccountID],
    FTstg.[AddressID],
    FTstg.[DocketID],
    FTstg.[ConsignmentStatusID],
    FTstg.[LotNumber],
    FTstg.[ReserveTypeID],
    FTstg.[ReserveAmount],
    FTstg.[ShortDescription],
    FTstg.[LongDescription],
    FTstg.[PhotosReceived],
    FTstg.[Showcase],
    FTstg.[ConsignmentCreated],
    FTstg.[ConsignmentUpdateEventID],
    FTstg.[CarCard],
    FTstg.[TitleIn],
    FTstg.[OnSite],
    FTstg.[CheckedIn],
    FTstg.[Completed],
    FTstg.[Canceled],
    FTstg.[CarInfoID],
    FTstg.[OnSpeed],
    FTstg.[OnHagerty],
    FTstg.[CustomerEstimatedValue],
    FTstg.[IsCharity],
    FTstg.[BJValue],
    FTstg.[ConsignmentCreatedUTC],
    FTstg.[ConsignmentModifiedUTC],
    FTstg.[EMAInventoryID],
    FTstg.[EMAEventID],
    FTstg.[EMACCEventID],
    FTstg.[EMAShowEventID],
    FTstg.[EMAMERCEventID],
    FTstg.[EMALotID],
    FTstg.[MarketingDescription],
    FTstg.[AuthorizedWeb],
    FTstg.[AuthorizedSocial],
    FTstg.[AuthorizedMarketing],
    FTstg.[AuthorizedCarList],
    FTstg.[HasLockMarketingDescription],
    FTstg.[ReviewStateID],
    FTstg.[DisplayStatusID],
    FTstg.[AssignedToUserID],
    FTstg.[Priority],
    FTstg.[Quality],
    FTstg.[RequestedAuctionID],
    FTstg.[StockNumber],
    FTstg.[IsOutTakeVehicle],
    FTstg.[CreatedByUserID],
    FTstg.[ModifiedByUserID],
    FTstg.[ModifiedDate],
    FTstg.[ModifiedFields],
    FTstg.[ConsignmentCompleteStatusBIT],
    FTstg.[ModifiedDetailsUTC],
    FTstg.[ModifiedDocketUTC],
    FTstg.[PaymentStatus],
    FTstg.[PaymentStatusBIT],
    FTstg.[OnlineAuctionItemID],
    FTstg.[OnlineAuctionAuctionItemID],
    FTstg.[IsReleasedForTransport],
    FTstg.[ConsignmentNotifyBIT],
    FTstg.[HasValidDocketIDAndLotNumber],
    FTstg.[LotStatus],
    FTstg.[TargetTime],
    FTstg.[ActualTime],
    FTstg.[DocketCreated],
    FTstg.[DocketUpdateEventID],
    FTstg.[LaneNumber]
    from stg.Auct_Consignment_FT_tmp as FTtmp 
    join stg.Auct_Consignment_FT_stg as FTstg 
    on FTstg.temp_ConsignmentID_DocketID=FTtmp.temp_ConsignmentID_DocketID
),
insertData as (
    select 
        [temp_ConsignmentID_DocketID],
        [Consignor_Skey],
        [Auction_Skey],
        [Item_Skey],
        [ConsignmentID],
        [AuctionID],
        [ItemID],
        [CustomerAccountID],
        [AddressID],
        [DocketID],
        [ConsignmentStatusID],
        [LotNumber],
        [ReserveTypeID],
        [ReserveAmount],
        [ShortDescription],
        [LongDescription],
        [PhotosReceived],
        [Showcase],
        [ConsignmentCreated],
        [ConsignmentUpdateEventID],
        [CarCard],
        [TitleIn],
        [OnSite],
        [CheckedIn],
        [Completed],
        [Canceled],
        [CarInfoID],
        [OnSpeed],
        [OnHagerty],
        [CustomerEstimatedValue],
        [IsCharity],
        [BJValue],
        [ConsignmentCreatedUTC],
        [ConsignmentModifiedUTC],
        [EMAInventoryID],
        [EMAEventID],
        [EMACCEventID],
        [EMAShowEventID],
        [EMAMERCEventID],
        [EMALotID],
        [MarketingDescription],
        [AuthorizedWeb],
        [AuthorizedSocial],
        [AuthorizedMarketing],
        [AuthorizedCarList],
        [HasLockMarketingDescription],
        [ReviewStateID],
        [DisplayStatusID],
        [AssignedToUserID],
        [Priority],
        [Quality],
        [RequestedAuctionID],
        [StockNumber],
        [IsOutTakeVehicle],
        [CreatedByUserID],
        [ModifiedByUserID],
        [ModifiedDate],
        [ModifiedFields],
        [ConsignmentCompleteStatusBIT],
        [ModifiedDetailsUTC],
        [ModifiedDocketUTC],
        [PaymentStatus],
        [PaymentStatusBIT],
        [OnlineAuctionItemID],
        [OnlineAuctionAuctionItemID],
        [IsReleasedForTransport],
        [ConsignmentNotifyBIT],
        [HasValidDocketIDAndLotNumber],
        [LotStatus],
        [TargetTime],
        [ActualTime],
        [DocketCreated],
        [DocketUpdateEventID],
        [LaneNumber]
    from stg.Auct_Consignment_FT_tmp
    where temp_ConsignmentID_DocketID not in (select  temp_ConsignmentID_DocketID from stg.Auct_Consignment_FT_stg) 
)
SELECT
    [Consignor_Skey],
    [Auction_Skey],
    [Item_Skey],
    [ConsignmentStatusID],
    [LotNumber],
    [ReserveTypeID],
    [ReserveAmount],
    [ShortDescription],
    [LongDescription],
    [PhotosReceived],
    [Showcase],
    [ConsignmentCreated],
    [ConsignmentUpdateEventID],
    [CarCard],
    [TitleIn],
    [Onsite],
    [CheckedIn],
    [Completed],
    [Canceled],
    [CarInfoID],
    [OnSpeed],
    [OnHagerty],
    [CustomerEstimatedValue],
    [IsCharity],
    [BJValue],
    [ConsignmentCreatedUTC],
    [ConsignmentModifiedUTC],
    [EMAInventoryID],
    [EMAEventID],
    [EMACCEventID],
    [EMAShowEventID],
    [EMAMERCEventID],
    [EMALotID],
    [MarketingDescription],
    [AuthorizedWeb],
    [AuthorizedSocial],
    [AuthorizedMarketing],
    [AuthorizedCarList],
    [HasLockMarketingDescription],
    [ReviewStateID],
    [DisplayStatusID],
    [AssignedToUserID],
    [Priority],
    [Quality],
    [RequestedAuctionID],
    [StockNumber],
    [IsOutTakeVehicle],
    [CreatedByUserID],
    [ModifiedByUserID],
    [ModifiedDate],
    [ModifiedFields],
    [ConsignmentCompleteStatusBIT],
    [ModifiedDetailsUTC],
    [ModifiedDocketUTC],
    [PaymentStatus],
    [PaymentStatusBIT],
    [OnlineAuctionItemID],
    [OnlineAuctionAuctionItemID],
    [IsReleasedForTransport],
    [ConsignmentNotifyBIT],
    [HasValidDocketIDAndLotNumber],
    [LotStatus],
    [TargetTime],
    [ActualTime],
    [DocketCreated],
    [DocketUpdateEventID],
    [LaneNumber]
from updateData
union all

SELECT
    [Consignor_Skey],
    [Auction_Skey],
    [Item_Skey],
    [ConsignmentStatusID],
    [LotNumber],
    [ReserveTypeID],
    [ReserveAmount],
    [ShortDescription],
    [LongDescription],
    [PhotosReceived],
    [Showcase],
    [ConsignmentCreated],
    [ConsignmentUpdateEventID],
    [CarCard],
    [TitleIn],
    [Onsite],
    [CheckedIn],
    [Completed],
    [Canceled],
    [CarInfoID],
    [OnSpeed],
    [OnHagerty],
    [CustomerEstimatedValue],
    [IsCharity],
    [BJValue],
    [ConsignmentCreatedUTC],
    [ConsignmentModifiedUTC],
    [EMAInventoryID],
    [EMAEventID],
    [EMACCEventID],
    [EMAShowEventID],
    [EMAMERCEventID],
    [EMALotID],
    [MarketingDescription],
    [AuthorizedWeb],
    [AuthorizedSocial],
    [AuthorizedMarketing],
    [AuthorizedCarList],
    [HasLockMarketingDescription],
    [ReviewStateID],
    [DisplayStatusID],
    [AssignedToUserID],
    [Priority],
    [Quality],
    [RequestedAuctionID],
    [StockNumber],
    [IsOutTakeVehicle],
    [CreatedByUserID],
    [ModifiedByUserID],
    [ModifiedDate],
    [ModifiedFields],
    [ConsignmentCompleteStatusBIT],
    [ModifiedDetailsUTC],
    [ModifiedDocketUTC],
    [PaymentStatus],
    [PaymentStatusBIT],
    [OnlineAuctionItemID],
    [OnlineAuctionAuctionItemID],
    [IsReleasedForTransport],
    [ConsignmentNotifyBIT],
    [HasValidDocketIDAndLotNumber],
    [LotStatus],
    [TargetTime],
    [ActualTime],
    [DocketCreated],
    [DocketUpdateEventID],
    [LaneNumber]
from insertData