
  
  if object_id ('"dbo"."Auct_Customer_Archive_BR_Full__dbt_tmp_temp_view"','V') is not null
    begin
    drop view "dbo"."Auct_Customer_Archive_BR_Full__dbt_tmp_temp_view"
    end


   
    
  if object_id ('"dbo"."Auct_Customer_Archive_BR_Full__dbt_tmp"','U') is not null
    begin
    drop table "dbo"."Auct_Customer_Archive_BR_Full__dbt_tmp"
    end


   EXEC('create view dbo.Auct_Customer_Archive_BR_Full__dbt_tmp_temp_view as
    
With ValidDates AS (
    SELECT [CustomerAccountID], [EffectiveStartDate] AS [Date] FROM [stg].[Auct_Email_Merge]
    UNION
    SELECT [CustomerAccountID], [EffectiveEndDate] AS [Date] FROM [stg].[Auct_Email_Merge]
    UNION
    SELECT [CustomerAccountID], [EffectiveStartDate] AS [Date] FROM [stg].[Auct_Phone_Merge]
    UNION
    SELECT [CustomerAccountID], [EffectiveEndDate] AS [Date] FROM [stg].[Auct_Phone_Merge]
    UNION
    SELECT [CustomerAccountID], [EffectiveStartDate] AS [Date] FROM [stg].[Auct_Address_Merge]
    UNION
    SELECT [CustomerAccountID], [EffectiveEndDate] AS [Date] FROM [stg].[Auct_Address_Merge]
)
, ValidDateRanges AS (
    SELECT 
        [CustomerAccountID],
        [EffectiveStartDate],
        [EffectiveEndDate]
    FROM (
        SELECT 
            [CustomerAccountID],
            [Date] AS [EffectiveStartDate],
            LEAD([Date], 1) OVER(
                                PARTITION BY [CustomerAccountID]
                                ORDER BY [Date]
            ) AS [EffectiveEndDate]
        FROM ValidDates
        ) AS temp1
    WHERE [EffectiveEndDate] IS NOT NULL 
)
, Auct_Customer_CTE1 AS (
    SELECT 
        addrmrg.[CustomerAccountID],
        emailmrg.[ContactID],
        emailmrg.[EmailAddress],
        emailmrg.[IsActiveEmail],
        emailmrg.[EmailBlastOptIn],
        -- phmrg.[PhoneID],
        -- phmrg.[PhoneNumber],
        -- phmrg.[PhoneType],
        -- phmrg.[PhoneStatus],
        -- phmrg.[IsDefaultPhone],
        -- phmrg.[IsActivePhone],
        phmrg.[MobilePhone_PhoneID], 
        phmrg.[MobilePhone_PhoneNumber], 
        phmrg.[MobilePhone_PhoneStatus], 
        phmrg.[IsDefaultMobilePhone], 
        phmrg.[IsActiveMobilePhone], 
        phmrg.[DirectPhone_PhoneID], 
        phmrg.[DirectPhone_PhoneNumber], 
        phmrg.[DirectPhone_PhoneStatus],
        phmrg.[IsDefaultDirectPhone],  
        phmrg.[IsActiveDirectPhone],  
        phmrg.[HomePhone_PhoneID],
        phmrg.[HomePhone_PhoneNumber], 
        phmrg.[HomePhone_PhoneStatus],  
        phmrg.[IsDefaultHomePhone],  
        phmrg.[IsActiveHomePhone],  
        phmrg.[HomeFax_PhoneID],  
        phmrg.[HomeFax_PhoneNumber], 
        phmrg.[HomeFax_PhoneStatus],  
        phmrg.[IsDefaultHomeFax],  
        phmrg.[IsActiveHomeFax],  
        phmrg.[DealerMobile_PhoneID],  
        phmrg.[DealerMobile_PhoneNumber], 
        phmrg.[DealerMobile_PhoneStatus],  
        phmrg.[IsDefaultDealerMobile],  
        phmrg.[IsActiveDealerMobile],  
        phmrg.[DealerPhone_PhoneID],  
        phmrg.[DealerPhone_PhoneNumber], 
        phmrg.[DealerPhone_PhoneStatus],  
        phmrg.[IsDefaultDealerPhone],  
        phmrg.[IsActiveDealerPhone],  
        phmrg.[DealerFax_PhoneID],  
        phmrg.[DealerFax_PhoneNumber], 
        phmrg.[DealerFax_PhoneStatus],  
        phmrg.[IsDefaultDealerFax],  
        phmrg.[IsActiveDealerFax],  
        phmrg.[BusinessPhone_PhoneID],  
        phmrg.[BusinessPhone_PhoneNumber], 
        phmrg.[BusinessPhone_PhoneStatus],  
        phmrg.[IsDefaultBusinessPhone],  
        phmrg.[IsActiveBusinessPhone],  
        phmrg.[BusinessFax_PhoneID],  
        phmrg.[BusinessFax_PhoneNumber], 
        phmrg.[BusinessFax_PhoneStatus],  
        phmrg.[IsDefaultBusinessFax],  
        phmrg.[IsActiveBusinessFax],  
        phmrg.[BusinessMobile_PhoneID],  
        phmrg.[BusinessMobile_PhoneNumber], 
        phmrg.[BusinessMobile_PhoneStatus],  
        phmrg.[IsDefaultBusinessMobile],  
        phmrg.[IsActiveBusinessMobile], 
        phmrg.[VendorPhone_PhoneID],  
        phmrg.[VendorPhone_PhoneNumber], 
        phmrg.[VendorPhone_PhoneStatus],  
        phmrg.[IsDefaultVendorPhone],      
        phmrg.[IsActiveVendorPhone],  
        phmrg.[VendorFax_PhoneID],  
        phmrg.[VendorFax_PhoneNumber], 
        phmrg.[VendorFax_PhoneStatus],  
        phmrg.[IsDefaultVendorFax],  
        phmrg.[IsActiveVendorFax],  
        phmrg.[RequestNumber_PhoneID],  
        phmrg.[RequestNumber_PhoneNumber], 
        phmrg.[RequestNumber_PhoneStatus],  
        phmrg.[IsDefaultRequestNumber],  
        phmrg.[IsActiveRequestNumber],  
        phmrg.[RequestFax_PhoneID],  
        phmrg.[RequestFax_PhoneNumber],
        phmrg.[RequestFax_PhoneStatus],
        phmrg.[IsDefaultRequestFax],
        phmrg.[IsActiveRequestFax],
        phmrg.[LocalPhone_PhoneID],
        phmrg.[LocalPhone_PhoneNumber],
        phmrg.[LocalPhone_PhoneStatus], 
        phmrg.[IsDefaultLocalPhone],
        phmrg.[IsActiveLocalPhone], 
        phmrg.[Pager_PhoneID],
        phmrg.[Pager_PhoneNumber], 
        phmrg.[Pager_PhoneStatus],  
        phmrg.[IsDefaultPager],
        phmrg.[IsActivePager],
        phmrg.[UnknownPhoneType_PhoneID],
        phmrg.[UnknownPhoneType_PhoneNumber], 
        phmrg.[UnknownPhoneType_PhoneStatus],  
        phmrg.[IsDefaultUnknownPhoneType],
        phmrg.[IsActiveUnknownPhoneType],
        addrmrg.[CurrentCompanyID],
        addrmrg.[AddressID],
        -- addrmrg.[AddressType],
        -- addrmrg.[Address],
        addrmrg.[HomeAddress], 
        addrmrg.[BusinessAddress], 
        addrmrg.[LocalAddress], 
        addrmrg.[DealerAddress], 
        addrmrg.[MailingAddress],
        addrmrg.[City],
        addrmrg.[State],
        addrmrg.[PostalCode],
        addrmrg.[Country],
        addrmrg.[AddressStatus],
        addrmrg.[IsDefaultAddress],
        addrmrg.[IsActiveAddress],
        vdrstg.[EffectiveStartDate],
        vdrstg.[EffectiveEndDate]
        -- emailmrg.[IsCurrent] AS [IsCurrentEmail],
        -- phmrg.[IsCurrent] AS [IsCurrentPhone],
        -- addrmrg.[IsCurrent] AS [IsCurrentAddress], 
    FROM [stg].[Auct_Address_Merge] addrmrg
    INNER JOIN ValidDateRanges vdrstg 
        ON vdrstg.[CustomerAccountID]=addrmrg.[CustomerAccountID]
            AND addrmrg.[EffectiveEndDate]>vdrstg.[EffectiveStartDate]
            AND  addrmrg.[EffectiveStartDate]<vdrstg.[EffectiveEndDate]
    LEFT JOIN [stg].[Auct_Email_Merge] emailmrg
        ON vdrstg.[CustomerAccountID]=emailmrg.[CustomerAccountID]
            AND emailmrg.[EffectiveEndDate]>vdrstg.[EffectiveStartDate]
            AND emailmrg.[EffectiveStartDate]<vdrstg.[EffectiveEndDate] 
    LEFT JOIN [stg].[Auct_Phone_Merge] phmrg
        ON vdrstg.[CustomerAccountID]=phmrg.[CustomerAccountID]
            AND phmrg.[EffectiveEndDate]>vdrstg.[EffectiveStartDate]
            AND  phmrg.[EffectiveStartDate]<vdrstg.[EffectiveEndDate] 
    WHERE COALESCE(emailmrg.[EmailAddress], phmrg.[MobilePhone_PhoneNumber], phmrg.[DirectPhone_PhoneNumber], phmrg.[HomePhone_PhoneNumber], phmrg.[HomeFax_PhoneNumber], phmrg.[DealerMobile_PhoneNumber], phmrg.[DealerPhone_PhoneNumber], phmrg.[DealerFax_PhoneNumber], phmrg.[BusinessPhone_PhoneNumber], phmrg.[BusinessFax_PhoneNumber], phmrg.[BusinessMobile_PhoneNumber], phmrg.[VendorPhone_PhoneNumber], phmrg.[VendorFax_PhoneNumber], phmrg.[RequestNumber_PhoneNumber], phmrg.[RequestFax_PhoneNumber], phmrg.[LocalPhone_PhoneNumber], phmrg.[Pager_PhoneNumber], phmrg.[UnknownPhoneType_PhoneNumber], addrmrg.[HomeAddress], addrmrg.[BusinessAddress], addrmrg.[LocalAddress], addrmrg.[DealerAddress], addrmrg.[MailingAddress]) IS NOT NULL
)
, Auct_Customer AS (
    SELECT 
        [CustomerAccountID],
        [CurrentCompanyID],
        [PresumedCustomerType],
        [ContactID],
        [Name],
        [EmailAddress],
        [IsActiveEmail],
        [EmailBlastOptIn],
        -- [PhoneID],
        -- [PhoneNumber],
        -- [PhoneType],
        -- [PhoneStatus],
        -- [IsDefaultPhone],
        -- [IsActivePhone],
        [MobilePhone_PhoneID], 
        [MobilePhone_PhoneNumber], 
        [MobilePhone_PhoneStatus], 
        [IsDefaultMobilePhone], 
        [IsActiveMobilePhone], 
        [DirectPhone_PhoneID], 
        [DirectPhone_PhoneNumber], 
        [DirectPhone_PhoneStatus],
        [IsDefaultDirectPhone],  
        [IsActiveDirectPhone],  
        [HomePhone_PhoneID],
        [HomePhone_PhoneNumber], 
        [HomePhone_PhoneStatus],  
        [IsDefaultHomePhone],  
        [IsActiveHomePhone],  
        [HomeFax_PhoneID],  
        [HomeFax_PhoneNumber], 
        [HomeFax_PhoneStatus],  
        [IsDefaultHomeFax],  
        [IsActiveHomeFax],  
        [DealerMobile_PhoneID],  
        [DealerMobile_PhoneNumber], 
        [DealerMobile_PhoneStatus],  
        [IsDefaultDealerMobile],  
        [IsActiveDealerMobile],  
        [DealerPhone_PhoneID],  
        [DealerPhone_PhoneNumber], 
        [DealerPhone_PhoneStatus],  
        [IsDefaultDealerPhone],  
        [IsActiveDealerPhone],  
        [DealerFax_PhoneID],  
        [DealerFax_PhoneNumber], 
        [DealerFax_PhoneStatus],  
        [IsDefaultDealerFax],  
        [IsActiveDealerFax],  
        [BusinessPhone_PhoneID],  
        [BusinessPhone_PhoneNumber], 
        [BusinessPhone_PhoneStatus],  
        [IsDefaultBusinessPhone],  
        [IsActiveBusinessPhone],  
        [BusinessFax_PhoneID],  
        [BusinessFax_PhoneNumber], 
        [BusinessFax_PhoneStatus],  
        [IsDefaultBusinessFax],  
        [IsActiveBusinessFax],  
        [BusinessMobile_PhoneID],  
        [BusinessMobile_PhoneNumber], 
        [BusinessMobile_PhoneStatus],  
        [IsDefaultBusinessMobile],  
        [IsActiveBusinessMobile], 
        [VendorPhone_PhoneID],  
        [VendorPhone_PhoneNumber], 
        [VendorPhone_PhoneStatus],  
        [IsDefaultVendorPhone],      
        [IsActiveVendorPhone],  
        [VendorFax_PhoneID],  
        [VendorFax_PhoneNumber], 
        [VendorFax_PhoneStatus],  
        [IsDefaultVendorFax],  
        [IsActiveVendorFax],  
        [RequestNumber_PhoneID],  
        [RequestNumber_PhoneNumber], 
        [RequestNumber_PhoneStatus],  
        [IsDefaultRequestNumber],  
        [IsActiveRequestNumber],  
        [RequestFax_PhoneID],  
        [RequestFax_PhoneNumber],
        [RequestFax_PhoneStatus],
        [IsDefaultRequestFax],
        [IsActiveRequestFax],
        [LocalPhone_PhoneID],
        [LocalPhone_PhoneNumber],
        [LocalPhone_PhoneStatus], 
        [IsDefaultLocalPhone],
        [IsActiveLocalPhone], 
        [Pager_PhoneID],
        [Pager_PhoneNumber], 
        [Pager_PhoneStatus],  
        [IsDefaultPager],
        [IsActivePager],
        [UnknownPhoneType_PhoneID],
        [UnknownPhoneType_PhoneNumber], 
        [UnknownPhoneType_PhoneStatus],  
        [IsDefaultUnknownPhoneType],
        [IsActiveUnknownPhoneType],
        [AddressID],
        [HomeAddress], 
        [BusinessAddress], 
        [LocalAddress], 
        [DealerAddress], 
        [MailingAddress],
        [City],
        [State],
        [PostalCode],
        [Country],
        [AddressStatus],
        [IsDefaultAddress],
        [IsActiveAddress],
        CASE WHEN COALESCE([DealerMobile_PhoneNumber], [DealerPhone_PhoneNumber], [DealerFax_PhoneNumber], [DealerAddress]) IS NOT NULL THEN ''1'' 
        ELSE ''0''
        END AS [HasDealerInfo],
        [EffectiveStartDate],
        [EffectiveEndDate],
        [RowNumber],
        CASE WHEN [RowNumber]=''1'' 
            THEN ''1''
        ELSE ''0''
        END AS [IsCurrent] 
    FROM (
           SELECT 
            [CustomerAccountID],
            [CurrentCompanyID],
            [PresumedCustomerType],
            [ContactID],
            [Name],
            [EmailAddress],
            [IsActiveEmail],
            [EmailBlastOptIn],
            -- [PhoneID],
            -- [PhoneNumber],
            -- [PhoneType],
            -- [PhoneStatus],
            -- [IsDefaultPhone],
            -- [IsActivePhone],
            MIN([mobilephone_PhoneID]) AS [MobilePhone_PhoneID], 
            MIN([mobilephone_PhoneNumber]) AS [MobilePhone_PhoneNumber], 
            MIN([mobilephone_PhoneStatus]) AS [MobilePhone_PhoneStatus], 
            CAST(MIN([IsDefaultMobilephone]+0) AS BIT) AS [IsDefaultMobilePhone], 
            CAST(MIN([IsActiveMobilephone]+0) AS BIT) AS [IsActiveMobilePhone], 
            MIN([directphone_PhoneID]) AS [DirectPhone_PhoneID], 
            MIN([directphone_PhoneNumber]) AS [DirectPhone_PhoneNumber], 
            MIN([directphone_PhoneStatus]) AS [DirectPhone_PhoneStatus],
            CAST(MIN([IsDefaultDirectphone]+0) AS BIT) AS [IsDefaultDirectPhone],  
            CAST(MIN([IsActiveDirectphone]+0) AS BIT) AS [IsActiveDirectPhone],  
            MIN([homephone_PhoneID]) AS [HomePhone_PhoneID],
            MIN([homephone_PhoneNumber]) AS [HomePhone_PhoneNumber], 
            MIN([homephone_PhoneStatus]) AS [HomePhone_PhoneStatus],  
            CAST(MIN([IsDefaultHomephone]+0) AS BIT) AS [IsDefaultHomePhone],  
            CAST(MIN([IsActiveHomephone]+0) AS BIT) AS [IsActiveHomePhone],  
            MIN([homefax_PhoneID]) AS [HomeFax_PhoneID],  
            MIN([homefax_PhoneNumber]) AS [HomeFax_PhoneNumber], 
            MIN([homefax_PhoneStatus]) AS [HomeFax_PhoneStatus],  
            CAST(MIN([IsDefaultHomefax]+0) AS BIT) AS [IsDefaultHomeFax],  
            CAST(MIN([IsActiveHomefax]+0) AS BIT) AS [IsActiveHomeFax],  
            MIN([dealermobile_PhoneID]) AS [DealerMobile_PhoneID],  
            MIN([dealermobile_PhoneNumber]) AS [DealerMobile_PhoneNumber], 
            MIN([dealermobile_PhoneStatus]) AS [DealerMobile_PhoneStatus],  
            CAST(MIN([IsDefaultDealermobile]+0) AS BIT) AS [IsDefaultDealerMobile],  
            CAST(MIN([IsActiveDealermobile]+0) AS BIT) AS [IsActiveDealerMobile],  
            MIN([dealerphone_PhoneID]) AS [DealerPhone_PhoneID],  
            MIN([dealerphone_PhoneNumber]) AS [DealerPhone_PhoneNumber], 
            MIN([dealerphone_PhoneStatus]) AS [DealerPhone_PhoneStatus],  
            CAST(MIN([IsDefaultDealerphone]+0) AS BIT) AS [IsDefaultDealerPhone],  
            CAST(MIN([IsActiveDealerphone]+0) AS BIT) AS [IsActiveDealerPhone],  
            MIN([dealerfax_PhoneID]) AS [DealerFax_PhoneID],  
            MIN([dealerfax_PhoneNumber]) AS [DealerFax_PhoneNumber], 
            MIN([dealerfax_PhoneStatus]) AS [DealerFax_PhoneStatus],  
            CAST(MIN([IsDefaultDealerfax]+0) AS BIT) AS [IsDefaultDealerFax],  
            CAST(MIN([IsActiveDealerfax]+0) AS BIT) AS [IsActiveDealerFax],  
            MIN([businessphone_PhoneID]) AS [BusinessPhone_PhoneID],  
            MIN([businessphone_PhoneNumber]) AS [BusinessPhone_PhoneNumber], 
            MIN([businessphone_PhoneStatus]) AS [BusinessPhone_PhoneStatus],  
            CAST(MIN([IsDefaultBusinessphone]+0) AS BIT) AS [IsDefaultBusinessPhone],  
            CAST(MIN([IsActiveBusinessphone]+0) AS BIT) AS [IsActiveBusinessPhone],  
            MIN([businessfax_PhoneID]) AS [BusinessFax_PhoneID],  
            MIN([businessfax_PhoneNumber]) AS [BusinessFax_PhoneNumber], 
            MIN([businessfax_PhoneStatus]) AS [BusinessFax_PhoneStatus],  
            CAST(MIN([IsDefaultBusinessfax]+0) AS BIT) AS [IsDefaultBusinessFax],  
            CAST(MIN([IsActiveBusinessfax]+0) AS BIT) AS [IsActiveBusinessFax],  
            MIN([businessmobile_PhoneID]) AS [BusinessMobile_PhoneID],  
            MIN([businessmobile_PhoneNumber]) AS [BusinessMobile_PhoneNumber], 
            MIN([businessmobile_PhoneStatus]) AS [BusinessMobile_PhoneStatus],  
            CAST(MIN([IsDefaultBusinessMobile]+0) AS BIT) AS [IsDefaultBusinessMobile],  
            CAST(MIN([IsActiveBusinessmobile]+0) AS BIT) AS [IsActiveBusinessMobile], 
            MIN([vendorphone_PhoneID]) AS [VendorPhone_PhoneID],  
            MIN([vendorphone_PhoneNumber]) AS [VendorPhone_PhoneNumber], 
            MIN([vendorphone_PhoneStatus]) AS [VendorPhone_PhoneStatus],  
            CAST(MIN([IsDefaultVendorphone]+0) AS BIT) AS [IsDefaultVendorPhone],      
            CAST(MIN([IsActiveVendorphone]+0) AS BIT) AS [IsActiveVendorPhone],  
            MIN([vendorfax_PhoneID]) AS [VendorFax_PhoneID],  
            MIN([vendorfax_PhoneNumber]) AS [VendorFax_PhoneNumber], 
            MIN([vendorfax_PhoneStatus]) AS [VendorFax_PhoneStatus],  
            CAST(MIN([IsDefaultVendorfax]+0) AS BIT) AS [IsDefaultVendorFax],  
            CAST(MIN([IsActiveVendorfax]+0) AS BIT) AS [IsActiveVendorFax],  
            MIN([RequestNumber_PhoneID]) AS [RequestNumber_PhoneID],  
            MIN([RequestNumber_PhoneNumber]) AS [RequestNumber_PhoneNumber], 
            MIN([RequestNumber_PhoneStatus]) AS [RequestNumber_PhoneStatus],  
            CAST(MIN([IsDefaultRequestNumber]+0) AS BIT) AS [IsDefaultRequestNumber],  
            CAST(MIN([IsActiveRequestNumber]+0) AS BIT) AS [IsActiveRequestNumber],  
            MIN([requestfax_PhoneID]) AS [RequestFax_PhoneID],  
            MIN([requestfax_PhoneNumber]) AS [RequestFax_PhoneNumber],
            MIN([requestfax_PhoneStatus]) AS [RequestFax_PhoneStatus],
            CAST(MIN([IsDefaultRequestfax]+0) AS BIT) AS [IsDefaultRequestFax],
            CAST(MIN([IsActiveRequestfax]+0) AS BIT) AS [IsActiveRequestFax],
            MIN([localphone_PhoneID]) AS [LocalPhone_PhoneID],
            MIN([localphone_PhoneNumber]) AS [LocalPhone_PhoneNumber],
            MIN([localphone_PhoneStatus]) AS [LocalPhone_PhoneStatus], 
            CAST(MIN([IsDefaultLocalphone]+0) AS BIT) AS [IsDefaultLocalPhone],
            CAST(MIN([IsActiveLocalphone]+0) AS BIT) AS [IsActiveLocalPhone], 
            MIN([pager_PhoneID]) AS [Pager_PhoneID],
            MIN([pager_PhoneNumber]) AS [Pager_PhoneNumber], 
            MIN([pager_PhoneStatus]) AS [Pager_PhoneStatus],  
            CAST(MIN([IsDefaultPager]+0) AS BIT) AS [IsDefaultPager],
            CAST(MIN([IsActivePager]+0) AS BIT) AS [IsActivePager],
            MIN([UnknownPhoneType_PhoneID]) AS [UnknownPhoneType_PhoneID],
            MIN([UnknownPhoneType_PhoneNumber]) AS [UnknownPhoneType_PhoneNumber], 
            MIN([UnknownPhoneType_PhoneStatus]) AS [UnknownPhoneType_PhoneStatus],  
            CAST(MIN([IsDefaultUnknownPhoneType]+0) AS BIT) AS [IsDefaultUnknownPhoneType],
            CAST(MIN([IsActiveUnknownPhoneType]+0) AS BIT) AS [IsActiveUnknownPhoneType],
            [AddressID],
            -- [AddressType],
            -- [Address],
            [HomeAddress], 
            [BusinessAddress], 
            [LocalAddress], 
            [DealerAddress], 
            [MailingAddress],
            [City],
            [State],
            [PostalCode],
            [Country],
            [AddressStatus],
            [IsDefaultAddress],
            [IsActiveAddress],
            [EffectiveStartDate],
            [EffectiveEndDate],
            ROW_NUMBER() OVER(
                PARTITION BY [CustomerAccountID], [AddressID]
                ORDER BY [EffectiveStartDate] DESC
            ) AS [RowNumber]
        FROM (
            SELECT 
                cxstg1.[CustomerAccountID],
                cxstg1.[CurrentCompanyID],
                CASE     
                    WHEN histcompidstg.[CompanyID] IS NOT NULL 
                        THEN ''Corporate Customer''
                    ELSE ''Retail Customer''
                END AS [PresumedCustomerType],
                COALESCE(conmrg.[ContactID], cxstg1.[ContactID]) AS [ContactID],
                conmrg.[Name],
                cxstg1.[EmailAddress],
                cxstg1.[IsActiveEmail],
                cxstg1.[EmailBlastOptIn],
                -- cxstg1.[PhoneID],
                -- cxstg1.[PhoneNumber],
                -- cxstg1.[PhoneType],
                -- cxstg1.[PhoneStatus],
                -- cxstg1.[IsDefaultPhone],
                -- cxstg1.[IsActivePhone],
                cxstg1.[MobilePhone_PhoneID], 
                cxstg1.[MobilePhone_PhoneNumber], 
                cxstg1.[MobilePhone_PhoneStatus], 
                cxstg1.[IsDefaultMobilePhone], 
                cxstg1.[IsActiveMobilePhone], 
                cxstg1.[DirectPhone_PhoneID], 
                cxstg1.[DirectPhone_PhoneNumber], 
                cxstg1.[DirectPhone_PhoneStatus],
                cxstg1.[IsDefaultDirectPhone],  
                cxstg1.[IsActiveDirectPhone],  
                cxstg1.[HomePhone_PhoneID],
                cxstg1.[HomePhone_PhoneNumber], 
                cxstg1.[HomePhone_PhoneStatus],  
                cxstg1.[IsDefaultHomePhone],  
                cxstg1.[IsActiveHomePhone],  
                cxstg1.[HomeFax_PhoneID],  
                cxstg1.[HomeFax_PhoneNumber], 
                cxstg1.[HomeFax_PhoneStatus],  
                cxstg1.[IsDefaultHomeFax],  
                cxstg1.[IsActiveHomeFax],  
                cxstg1.[DealerMobile_PhoneID],  
                cxstg1.[DealerMobile_PhoneNumber], 
                cxstg1.[DealerMobile_PhoneStatus],  
                cxstg1.[IsDefaultDealerMobile],  
                cxstg1.[IsActiveDealerMobile],  
                cxstg1.[DealerPhone_PhoneID],  
                cxstg1.[DealerPhone_PhoneNumber], 
                cxstg1.[DealerPhone_PhoneStatus],  
                cxstg1.[IsDefaultDealerPhone],  
                cxstg1.[IsActiveDealerPhone],  
                cxstg1.[DealerFax_PhoneID],  
                cxstg1.[DealerFax_PhoneNumber], 
                cxstg1.[DealerFax_PhoneStatus],  
                cxstg1.[IsDefaultDealerFax],  
                cxstg1.[IsActiveDealerFax],  
                cxstg1.[BusinessPhone_PhoneID],  
                cxstg1.[BusinessPhone_PhoneNumber], 
                cxstg1.[BusinessPhone_PhoneStatus],  
                cxstg1.[IsDefaultBusinessPhone],  
                cxstg1.[IsActiveBusinessPhone],  
                cxstg1.[BusinessFax_PhoneID],  
                cxstg1.[BusinessFax_PhoneNumber], 
                cxstg1.[BusinessFax_PhoneStatus],  
                cxstg1.[IsDefaultBusinessFax],  
                cxstg1.[IsActiveBusinessFax],  
                cxstg1.[BusinessMobile_PhoneID],  
                cxstg1.[BusinessMobile_PhoneNumber], 
                cxstg1.[BusinessMobile_PhoneStatus],  
                cxstg1.[IsDefaultBusinessMobile],  
                cxstg1.[IsActiveBusinessMobile], 
                cxstg1.[VendorPhone_PhoneID],  
                cxstg1.[VendorPhone_PhoneNumber], 
                cxstg1.[VendorPhone_PhoneStatus],  
                cxstg1.[IsDefaultVendorPhone],      
                cxstg1.[IsActiveVendorPhone],  
                cxstg1.[VendorFax_PhoneID],  
                cxstg1.[VendorFax_PhoneNumber], 
                cxstg1.[VendorFax_PhoneStatus],  
                cxstg1.[IsDefaultVendorFax],  
                cxstg1.[IsActiveVendorFax],  
                cxstg1.[RequestNumber_PhoneID],  
                cxstg1.[RequestNumber_PhoneNumber], 
                cxstg1.[RequestNumber_PhoneStatus],  
                cxstg1.[IsDefaultRequestNumber],  
                cxstg1.[IsActiveRequestNumber],  
                cxstg1.[RequestFax_PhoneID],  
                cxstg1.[RequestFax_PhoneNumber],
                cxstg1.[RequestFax_PhoneStatus],
                cxstg1.[IsDefaultRequestFax],
                cxstg1.[IsActiveRequestFax],
                cxstg1.[LocalPhone_PhoneID],
                cxstg1.[LocalPhone_PhoneNumber],
                cxstg1.[LocalPhone_PhoneStatus], 
                cxstg1.[IsDefaultLocalPhone],
                cxstg1.[IsActiveLocalPhone], 
                cxstg1.[Pager_PhoneID],
                cxstg1.[Pager_PhoneNumber], 
                cxstg1.[Pager_PhoneStatus],  
                cxstg1.[IsDefaultPager],
                cxstg1.[IsActivePager],
                cxstg1.[UnknownPhoneType_PhoneID],
                cxstg1.[UnknownPhoneType_PhoneNumber], 
                cxstg1.[UnknownPhoneType_PhoneStatus],  
                cxstg1.[IsDefaultUnknownPhoneType],
                cxstg1.[IsActiveUnknownPhoneType],
                cxstg1.[AddressID],
                -- [AddressType],
                -- [Address],
                cxstg1.[HomeAddress], 
                cxstg1.[BusinessAddress], 
                cxstg1.[LocalAddress], 
                cxstg1.[DealerAddress], 
                cxstg1.[MailingAddress],
                cxstg1.[City],
                cxstg1.[State],
                cxstg1.[PostalCode],
                cxstg1.[Country],
                cxstg1.[AddressStatus],
                cxstg1.[IsDefaultAddress],
                cxstg1.[IsActiveAddress],
                cxstg1.[EffectiveStartDate],
                cxstg1.[EffectiveEndDate]
            FROM Auct_Customer_CTE1 cxstg1
            LEFT JOIN [stg].[Auct_Customer_HistoricalCompanyID_Lookup] histcompidstg
                ON cxstg1.[CustomerAccountID]=histcompidstg.[CustomerAccountID]
            LEFT JOIN [stg].[Auct_Contact_Merge] conmrg
                ON cxstg1.[CustomerAccountID]=conmrg.[CustomerAccountID]
                    -- AND cxstg1.[ContactID]=conmrg.[ContactID] -- WRONG! E.x. [CustomerAccountID] IN (28827)
                ) AS temp1
            GROUP BY [CustomerAccountID], [CurrentCompanyID], [PresumedCustomerType], [ContactID], [Name], [EmailAddress], [IsActiveEmail], [EmailBlastOptIn], [AddressID], [HomeAddress], [BusinessAddress], [LocalAddress], [DealerAddress], [MailingAddress], [City], [State], [PostalCode], [Country], [AddressStatus], [IsDefaultAddress], [IsActiveAddress], [EffectiveStartDate], [EffectiveEndDate]
            ) AS temp2
)
SELECT 
    HASHBYTES(''SHA2_256'', 
        CONCAT(
            COALESCE(CAST([CustomerAccountID] AS VARCHAR(20)), ''''), ''|'', 
            COALESCE(CAST([AddressID] AS VARCHAR(20)), ''''), ''|'', 
            COALESCE(CAST([RowNumber] AS VARCHAR(20)), '''')
        )
    ) AS [ArchivedCustomer_Skey],
    [CustomerAccountID],
    [CurrentCompanyID],
    [PresumedCustomerType],
    [ContactID],
    [Name],
    [EmailAddress],
    [IsActiveEmail],
    [EmailBlastOptIn],
    -- [PhoneID],
    -- [PhoneNumber],
    -- [PhoneType],
    -- [PhoneStatus],
    -- [IsDefaultPhone],
    -- [IsActivePhone],
    [MobilePhone_PhoneID], 
    [MobilePhone_PhoneNumber], 
    [MobilePhone_PhoneStatus], 
    [IsDefaultMobilePhone], 
    [IsActiveMobilePhone], 
    [DirectPhone_PhoneID], 
    [DirectPhone_PhoneNumber], 
    [DirectPhone_PhoneStatus],
    [IsDefaultDirectPhone],  
    [IsActiveDirectPhone],  
    [HomePhone_PhoneID],
    [HomePhone_PhoneNumber], 
    [HomePhone_PhoneStatus],  
    [IsDefaultHomePhone],  
    [IsActiveHomePhone],  
    [HomeFax_PhoneID],  
    [HomeFax_PhoneNumber], 
    [HomeFax_PhoneStatus],  
    [IsDefaultHomeFax],  
    [IsActiveHomeFax],  
    [DealerMobile_PhoneID],  
    [DealerMobile_PhoneNumber], 
    [DealerMobile_PhoneStatus],  
    [IsDefaultDealerMobile],  
    [IsActiveDealerMobile],  
    [DealerPhone_PhoneID],  
    [DealerPhone_PhoneNumber], 
    [DealerPhone_PhoneStatus],  
    [IsDefaultDealerPhone],  
    [IsActiveDealerPhone],  
    [DealerFax_PhoneID],  
    [DealerFax_PhoneNumber], 
    [DealerFax_PhoneStatus],  
    [IsDefaultDealerFax],  
    [IsActiveDealerFax],  
    [BusinessPhone_PhoneID],  
    [BusinessPhone_PhoneNumber], 
    [BusinessPhone_PhoneStatus],  
    [IsDefaultBusinessPhone],  
    [IsActiveBusinessPhone],  
    [BusinessFax_PhoneID],  
    [BusinessFax_PhoneNumber], 
    [BusinessFax_PhoneStatus],  
    [IsDefaultBusinessFax],  
    [IsActiveBusinessFax],  
    [BusinessMobile_PhoneID],  
    [BusinessMobile_PhoneNumber], 
    [BusinessMobile_PhoneStatus],  
    [IsDefaultBusinessMobile],  
    [IsActiveBusinessMobile], 
    [VendorPhone_PhoneID],  
    [VendorPhone_PhoneNumber], 
    [VendorPhone_PhoneStatus],  
    [IsDefaultVendorPhone],      
    [IsActiveVendorPhone],  
    [VendorFax_PhoneID],  
    [VendorFax_PhoneNumber], 
    [VendorFax_PhoneStatus],  
    [IsDefaultVendorFax],  
    [IsActiveVendorFax],  
    [RequestNumber_PhoneID],  
    [RequestNumber_PhoneNumber], 
    [RequestNumber_PhoneStatus],  
    [IsDefaultRequestNumber],  
    [IsActiveRequestNumber],  
    [RequestFax_PhoneID],  
    [RequestFax_PhoneNumber],
    [RequestFax_PhoneStatus],
    [IsDefaultRequestFax],
    [IsActiveRequestFax],
    [LocalPhone_PhoneID],
    [LocalPhone_PhoneNumber],
    [LocalPhone_PhoneStatus], 
    [IsDefaultLocalPhone],
    [IsActiveLocalPhone], 
    [Pager_PhoneID],
    [Pager_PhoneNumber], 
    [Pager_PhoneStatus],  
    [IsDefaultPager],
    [IsActivePager],
    [UnknownPhoneType_PhoneID],
    [UnknownPhoneType_PhoneNumber], 
    [UnknownPhoneType_PhoneStatus],  
    [IsDefaultUnknownPhoneType],
    [IsActiveUnknownPhoneType],
    [AddressID],
    [HomeAddress], 
    [BusinessAddress], 
    [LocalAddress], 
    [DealerAddress], 
    [MailingAddress],
    [City],
    [State],
    [PostalCode],
    [Country],
    [AddressStatus],
    [IsDefaultAddress],
    [IsActiveAddress],
    [HasDealerInfo],
    [EffectiveStartDate],
    [EffectiveEndDate],
    [IsCurrent]
FROM Auct_Customer
    ');

  CREATE TABLE "dbo"."Auct_Customer_Archive_BR_Full__dbt_tmp"
    WITH(
      DISTRIBUTION = ROUND_ROBIN,
      CLUSTERED COLUMNSTORE INDEX
      )
    AS (SELECT * FROM dbo.Auct_Customer_Archive_BR_Full__dbt_tmp_temp_view)

   
  
  if object_id ('"dbo"."Auct_Customer_Archive_BR_Full__dbt_tmp_temp_view"','V') is not null
    begin
    drop view "dbo"."Auct_Customer_Archive_BR_Full__dbt_tmp_temp_view"
    end


